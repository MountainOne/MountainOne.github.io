<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>Tag: Kaggle - MountainOne&#39;s technology space</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta property="og:type" content="website">
<meta property="og:title" content="MountainOne&#39;s technology space">
<meta property="og:url" content="http://yoursite.com/tags/Kaggle/index.html">
<meta property="og:site_name" content="MountainOne&#39;s technology space">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MountainOne&#39;s technology space">





<link rel="icon" href="/images/wangye.jpeg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/wangye.jpeg" alt="MountainOne&#39;s technology space" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="/tags">Tags</a>
                
                <a class="navbar-item" href="/about">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/MountainOne">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/tags">Tags</a></li>
            <li class="is-active"><a href="#" aria-current="page">Kaggle</a></li>
        </ul>
        </nav>
    </div>
</div>

    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2018-12-06T20:41:32.000Z">2018-12-06</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/数据挖掘/">数据挖掘</a>
                </div>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2018/12/07/Kaggle之房价预测/">Kaggle之房价预测</a>
            
        </h1>
        <div class="content">
            <h1 id="Kaggle入门赛之房价预测"><a href="#Kaggle入门赛之房价预测" class="headerlink" title="Kaggle入门赛之房价预测"></a>Kaggle入门赛之房价预测</h1><blockquote>
<p>前言：最近实验室有一个数据挖掘的任务需要完成，是一个和国家电网相关的回归任务。因此我在 Kaggle 上找一些回归任务的比赛来练练手，房价预测这个比赛的难度比较适合我这种新手，因此选择了这个题目。本篇博客的大部分内容来自该比赛的一个高分 <a href="https://www.kaggle.com/serigne/stacked-regressions-top-4-on-leaderboard" target="_blank" rel="noopener">kernel</a>, 感兴趣的同学可以直接跳转查看原博。</p>
</blockquote>
<h2 id="1-比赛介绍"><a href="#1-比赛介绍" class="headerlink" title="1.比赛介绍"></a>1.比赛介绍</h2><p>这是 Kaggle 上的一个为数据科学初学者准备的比赛，需要参赛者掌握一定的 R 或 Python 以及机器学习的基础知识。它给出了一个训练集和一个测试集，最终需要对测试集中的结果进行预测并提交。训练集中包含了79个特征以预测房价（SalePrice），包括：房屋的大小、地段、用途、基础设施等等。具体的描述可查看该比赛的<a href="https://www.kaggle.com/c/house-prices-advanced-regression-techniques" target="_blank" rel="noopener">比赛页面</a>,比赛中所用到数据也均可通过比赛页面下载。</p>
<h2 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2.准备工作"></a>2.准备工作</h2><p>数据挖掘类的比赛最为重要的工作就是：<strong>特征工程</strong>。本篇博客将会用到的特征工程方法还是非常朴素的，具体如下：</p>
<ul>
<li>通过已有的数据拟合曲线来<strong>填充缺失值</strong>。</li>
<li><strong>变换</strong>某些看起来更像分类变量的数值型变量。</li>
<li><strong>标签编码</strong>一些带有排序信息的分类变量（例如，标签顺序按照出现次数大小排序）。</li>
<li>对于一些倾斜特征采用 <strong>Box Cox 变换</strong>（替代对数变换）：这会得到一个更好的结果。</li>
<li>得到分类特征的假值。</li>
</ul>
<p>之后我们将会选择一些基本模型（例如基于 sklearn 的 XGBoost），在 stacking/ensembling 之前在数据集上进行交叉验证。它的关键在于让（线性）模型对异常值鲁棒。这将同时提高积分板和交叉验证的分数。</p>
<p>接下来真正开始工作吧！首先导入相关的包和比赛所需的数据。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#import some necessary librairies</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np <span class="hljs-comment"># linear algebra</span></span><br><span class="line"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd <span class="hljs-comment"># data processing, CSV file I/O (e.g. pd.read_csv)</span></span><br><span class="line">%matplotlib inline</span><br><span class="line"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt  <span class="hljs-comment"># Matlab-style plotting</span></span><br><span class="line"><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns</span><br><span class="line">color = sns.color_palette()</span><br><span class="line">sns.set_style(<span class="hljs-string">'darkgrid'</span>)</span><br><span class="line"><span class="hljs-keyword">import</span> warnings</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ignore_warn</span><span class="hljs-params">(*args, **kwargs)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">pass</span></span><br><span class="line">warnings.warn = ignore_warn <span class="hljs-comment">#ignore annoying warning (from sklearn and seaborn)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats</span><br><span class="line"><span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> norm, skew <span class="hljs-comment">#for some statistics</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pd.set_option(<span class="hljs-string">'display.float_format'</span>, <span class="hljs-keyword">lambda</span> x: <span class="hljs-string">'&#123;:.3f&#125;'</span>.format(x)) <span class="hljs-comment">#Limiting floats output to 3 decimal points</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">from</span> subprocess <span class="hljs-keyword">import</span> check_output</span><br><span class="line">print(check_output([<span class="hljs-string">"ls"</span>, <span class="hljs-string">"../input"</span>]).decode(<span class="hljs-string">"utf8"</span>)) <span class="hljs-comment">#check the files available in the directory</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>sample_submission.csv</p>
<p>test.csv</p>
<p>train.csv</p>
</blockquote>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#Now let's import and put the train and test datasets in  pandas dataframe</span></span><br><span class="line"></span><br><span class="line">train = pd.read_csv(<span class="hljs-string">'../input/train.csv'</span>)</span><br><span class="line">test = pd.read_csv(<span class="hljs-string">'../input/test.csv'</span>)</span><br><span class="line"><span class="hljs-comment">##display the first five rows of the train dataset.</span></span><br><span class="line">train.head(<span class="hljs-number">5</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/images/房价预测/6.png" alt=""></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">##display the first five rows of the test dataset.</span></span><br><span class="line">test.head(<span class="hljs-number">5</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/images/房价预测/3.png" alt=""></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#check the numbers of samples and features</span></span><br><span class="line">print(<span class="hljs-string">"The train data size before dropping Id feature is : &#123;&#125; "</span>.format(train.shape))</span><br><span class="line">print(<span class="hljs-string">"The test data size before dropping Id feature is : &#123;&#125; "</span>.format(test.shape))</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Save the 'Id' column</span></span><br><span class="line">train_ID = train[<span class="hljs-string">'Id'</span>]</span><br><span class="line">test_ID = test[<span class="hljs-string">'Id'</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Now drop the  'Id' colum since it's unnecessary for  the prediction process.</span></span><br><span class="line">train.drop(<span class="hljs-string">"Id"</span>, axis = <span class="hljs-number">1</span>, inplace = <span class="hljs-keyword">True</span>)</span><br><span class="line">test.drop(<span class="hljs-string">"Id"</span>, axis = <span class="hljs-number">1</span>, inplace = <span class="hljs-keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#check again the data size after dropping the 'Id' variable</span></span><br><span class="line">print(<span class="hljs-string">"\nThe train data size after dropping Id feature is : &#123;&#125; "</span>.format(train.shape)) </span><br><span class="line">print(<span class="hljs-string">"The test data size after dropping Id feature is : &#123;&#125; "</span>.format(test.shape))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;The train data size before dropping Id feature is : (1460, 81) </span><br><span class="line">&gt;The test data size before dropping Id feature is : (1459, 80) </span><br><span class="line">&gt;</span><br><span class="line">&gt;The train data size after dropping Id feature is : (1460, 80) </span><br><span class="line">&gt;The test data size after dropping Id feature is : (1459, 79) </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="3-数据处理"><a href="#3-数据处理" class="headerlink" title="3.数据处理"></a>3.数据处理</h2><h3 id="异常值"><a href="#异常值" class="headerlink" title="异常值"></a>异常值</h3><p>首先对数据集中的重要特征的异常值进行处理。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fig, ax = plt.subplots()</span><br><span class="line">ax.scatter(x = train[<span class="hljs-string">'GrLivArea'</span>], y = train[<span class="hljs-string">'SalePrice'</span>])</span><br><span class="line">plt.ylabel(<span class="hljs-string">'SalePrice'</span>, fontsize=<span class="hljs-number">13</span>)</span><br><span class="line">plt.xlabel(<span class="hljs-string">'GrLivArea'</span>, fontsize=<span class="hljs-number">13</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="/images/房价预测/4.png" alt=""></p>
<p>可从散点图中看到有两个非常明显的异常值，有着极大的房屋面积房价却很低。这两个值是非常典型的异常值，因此可以安全地删除它们。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#Deleting outliers</span></span><br><span class="line">train = train.drop(train[(train[<span class="hljs-string">'GrLivArea'</span>]&gt;<span class="hljs-number">4000</span>) &amp; (train[<span class="hljs-string">'SalePrice'</span>]&lt;<span class="hljs-number">300000</span>)].index)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Check the graphic again</span></span><br><span class="line">fig, ax = plt.subplots()</span><br><span class="line">ax.scatter(train[<span class="hljs-string">'GrLivArea'</span>], train[<span class="hljs-string">'SalePrice'</span>])</span><br><span class="line">plt.ylabel(<span class="hljs-string">'SalePrice'</span>, fontsize=<span class="hljs-number">13</span>)</span><br><span class="line">plt.xlabel(<span class="hljs-string">'GrLivArea'</span>, fontsize=<span class="hljs-number">13</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="/images/房价预测/0.png" alt=""></p>
<h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p>删除异常值并不总是安全的。我们决定删除这两个值是因为它俩太奇怪了（极大的空间有着极低的价格）。</p>
<p>数据集中仍然可能存在其它的异常值。然而删除所有的异常值可能对模型产生不好的影响，特别是当它们可能出现在测试集的时候。因此在处理异常值得时候最好不要全部删除掉，以提高模型的鲁棒性。</p>
<h3 id="目标变量"><a href="#目标变量" class="headerlink" title="目标变量"></a>目标变量</h3><p><strong>房价</strong>是我们需要预测的目标变量，因此首先对它进行一些分析。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df_train[<span class="hljs-string">'SalePrice'</span>].describe()</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;count      1460.000000</span><br><span class="line">&gt;mean     180921.195890</span><br><span class="line">&gt;std       79442.502883</span><br><span class="line">&gt;min       34900.000000</span><br><span class="line">&gt;25%      129975.000000</span><br><span class="line">&gt;50%      163000.000000</span><br><span class="line">&gt;75%      214000.000000</span><br><span class="line">&gt;max      755000.000000</span><br><span class="line">&gt;Name: SalePrice, dtype: float64</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sns.distplot(train[<span class="hljs-string">'SalePrice'</span>] , fit=norm);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Get the fitted parameters used by the function</span></span><br><span class="line">(mu, sigma) = norm.fit(train[<span class="hljs-string">'SalePrice'</span>])</span><br><span class="line">print( <span class="hljs-string">'\n mu = &#123;:.2f&#125; and sigma = &#123;:.2f&#125;\n'</span>.format(mu, sigma))</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Now plot the distribution</span></span><br><span class="line">plt.legend([<span class="hljs-string">'Normal dist. ($\mu=$ &#123;:.2f&#125; and $\sigma=$ &#123;:.2f&#125; )'</span>.format(mu, sigma)],</span><br><span class="line">            loc=<span class="hljs-string">'best'</span>)</span><br><span class="line">plt.ylabel(<span class="hljs-string">'Frequency'</span>)</span><br><span class="line">plt.title(<span class="hljs-string">'SalePrice distribution'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Get also the QQ-plot</span></span><br><span class="line">fig = plt.figure()</span><br><span class="line">res = stats.probplot(train[<span class="hljs-string">'SalePrice'</span>], plot=plt)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; mu = 180932.92 and sigma = 79467.79</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/images/房价预测/10.png" alt=""></p>
<p>目标变量是接近正态分布的。线性模型在正态分布的数据上拟合效果更好，所以我们可以对数据做一些变换使其更接近正态分布。</p>
<h4 id="目标变量的对数变换"><a href="#目标变量的对数变换" class="headerlink" title="目标变量的对数变换"></a>目标变量的对数变换</h4><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#We use the numpy fuction log1p which  applies log(1+x) to all elements of the column</span></span><br><span class="line">train[<span class="hljs-string">"SalePrice"</span>] = np.log1p(train[<span class="hljs-string">"SalePrice"</span>])</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Check the new distribution </span></span><br><span class="line">sns.distplot(train[<span class="hljs-string">'SalePrice'</span>] , fit=norm);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Get the fitted parameters used by the function</span></span><br><span class="line">(mu, sigma) = norm.fit(train[<span class="hljs-string">'SalePrice'</span>])</span><br><span class="line">print( <span class="hljs-string">'\n mu = &#123;:.2f&#125; and sigma = &#123;:.2f&#125;\n'</span>.format(mu, sigma))</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Now plot the distribution</span></span><br><span class="line">plt.legend([<span class="hljs-string">'Normal dist. ($\mu=$ &#123;:.2f&#125; and $\sigma=$ &#123;:.2f&#125; )'</span>.format(mu, sigma)],</span><br><span class="line">            loc=<span class="hljs-string">'best'</span>)</span><br><span class="line">plt.ylabel(<span class="hljs-string">'Frequency'</span>)</span><br><span class="line">plt.title(<span class="hljs-string">'SalePrice distribution'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Get also the QQ-plot</span></span><br><span class="line">fig = plt.figure()</span><br><span class="line">res = stats.probplot(train[<span class="hljs-string">'SalePrice'</span>], plot=plt)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; mu = 12.02 and sigma = 0.40</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/images/房价预测/7.png" alt=""></p>
<p>在经过对数变换后，房价数据接近于正态分布。</p>
<h2 id="4-特征工程"><a href="#4-特征工程" class="headerlink" title="4.特征工程"></a>4.特征工程</h2><p>首先将训练数据和测试数据合并到一个数据帧。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ntrain = train.shape[<span class="hljs-number">0</span>]</span><br><span class="line">ntest = test.shape[<span class="hljs-number">0</span>]</span><br><span class="line">y_train = train.SalePrice.values</span><br><span class="line">all_data = pd.concat((train, test)).reset_index(drop=<span class="hljs-keyword">True</span>)</span><br><span class="line">all_data.drop([<span class="hljs-string">'SalePrice'</span>], axis=<span class="hljs-number">1</span>, inplace=<span class="hljs-keyword">True</span>)</span><br><span class="line">print(<span class="hljs-string">"all_data size is : &#123;&#125;"</span>.format(all_data.shape))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;all_data size is : (2917, 79)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="缺失数据"><a href="#缺失数据" class="headerlink" title="缺失数据"></a>缺失数据</h3><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">all_data_na = (all_data.isnull().sum() / len(all_data)) * <span class="hljs-number">100</span></span><br><span class="line">all_data_na = all_data_na.drop(all_data_na[all_data_na == <span class="hljs-number">0</span>].index).sort_values(ascending=<span class="hljs-keyword">False</span>)[:<span class="hljs-number">30</span>]</span><br><span class="line">missing_data = pd.DataFrame(&#123;<span class="hljs-string">'Missing Ratio'</span> :all_data_na&#125;)</span><br><span class="line">missing_data.head(<span class="hljs-number">20</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/images/房价预测/1.png" alt=""></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f, ax = plt.subplots(figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">12</span>))</span><br><span class="line">plt.xticks(rotation=<span class="hljs-string">'90'</span>)</span><br><span class="line">sns.barplot(x=all_data_na.index, y=all_data_na)</span><br><span class="line">plt.xlabel(<span class="hljs-string">'Features'</span>, fontsize=<span class="hljs-number">15</span>)</span><br><span class="line">plt.ylabel(<span class="hljs-string">'Percent of missing values'</span>, fontsize=<span class="hljs-number">15</span>)</span><br><span class="line">plt.title(<span class="hljs-string">'Percent missing data by feature'</span>, fontsize=<span class="hljs-number">15</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;Text(0.5,1,&apos;Percent missing data by feature&apos;) </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/images/房价预测/2.png" alt=""></p>
<h3 id="数据关联"><a href="#数据关联" class="headerlink" title="数据关联"></a>数据关联</h3><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#Correlation map to see how features are correlated with SalePrice</span></span><br><span class="line">corrmat = train.corr()</span><br><span class="line">plt.subplots(figsize=(<span class="hljs-number">12</span>,<span class="hljs-number">9</span>))</span><br><span class="line">sns.heatmap(corrmat, vmax=<span class="hljs-number">0.9</span>, square=<span class="hljs-keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/images/房价预测/5.png" alt=""></p>
<h3 id="输入缺失值"><a href="#输入缺失值" class="headerlink" title="输入缺失值"></a>输入缺失值</h3><p>根据不同特征的不同情况对缺失值进行填充。</p>
<ol>
<li>对于离散值且数据说明里有 NA 选项，则将缺失值补为None。</li>
</ol>
<ul>
<li>PoolQC : 数据描述说 NA 表示 “没有泳池”。这是有意义的，因为有大量的缺失数据，这表明大多数的房子都没有游泳池。</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_data[<span class="hljs-string">"PoolQC"</span>] = all_data[<span class="hljs-string">"PoolQC"</span>].fillna(<span class="hljs-string">"None"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>MiscFeature : 数据描述说 NA 表示“没有杂项特征”。</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_data[<span class="hljs-string">"MiscFeature"</span>] = all_data[<span class="hljs-string">"MiscFeature"</span>].fillna(<span class="hljs-string">"None"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Alley : 数据描述说 NA 表示“没有小巷联通”。</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_data[<span class="hljs-string">"Alley"</span>] = all_data[<span class="hljs-string">"Alley"</span>].fillna(<span class="hljs-string">"None"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Fence : 数据描述说 NA 表示“没有棚栏”。</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_data[<span class="hljs-string">"Fence"</span>] = all_data[<span class="hljs-string">"Fence"</span>].fillna(<span class="hljs-string">"None"</span>)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>对于和其他特征有关联的值，可以先按其它特征分组，然后取中位数 。</li>
</ol>
<ul>
<li>LotFrontage : 因为房子附近的街道到房子的距离和到该房子临近的房子的距离是类似的，因此去临近房子的中位数来填充该距离。</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#Group by neighborhood and fill in missing value by the median LotFrontage of all the neighborhood</span></span><br><span class="line">all_data[<span class="hljs-string">"LotFrontage"</span>] = all_data.groupby(<span class="hljs-string">"Neighborhood"</span>)[<span class="hljs-string">"LotFrontage"</span>].transform(</span><br><span class="line">    <span class="hljs-keyword">lambda</span> x: x.fillna(x.median()))</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>对于连续值，将缺失的值补为0。</li>
</ol>
<ul>
<li><strong>BsmtFinSF1, BsmtFinSF2, BsmtUnfSF, TotalBsmtSF, BsmtFullBath and BsmtHalfBath</strong> :缺失的值为0意味着没有基础设施。</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> (<span class="hljs-string">'BsmtFinSF1'</span>, <span class="hljs-string">'BsmtFinSF2'</span>, <span class="hljs-string">'BsmtUnfSF'</span>,<span class="hljs-string">'TotalBsmtSF'</span>, <span class="hljs-string">'BsmtFullBath'</span>, <span class="hljs-string">'BsmtHalfBath'</span>):</span><br><span class="line">    all_data[col] = all_data[col].fillna(<span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>对于离散值且在数据说明里没有 NA 选项，则将缺失值填充为出现最多的值 。</li>
</ol>
<ul>
<li>MSZoning(大致区域分类)：‘RL’是最常见的值。所以我们使用‘RL’填充缺失值。</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_data[<span class="hljs-string">'MSZoning'</span>] = all_data[<span class="hljs-string">'MSZoning'</span>].fillna(all_data[<span class="hljs-string">'MSZoning'</span>].mode()[<span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>对于所有值几乎都一样，参考意义不大的特征，直接删除 。</li>
</ol>
<ul>
<li>Utilities:该特征所有的值几乎都为‘AllPub’,除了一个‘NoSeWa’和2个NA。因为唯一的’NoSewa’出现在训练集，这个特征将不会对预测有帮助，因此可以安全地移除它。</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_data = all_data.drop([<span class="hljs-string">'Utilities'</span>], axis=<span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>
<p>在缺失值处理完后，可以简单地查看是否还有未处理地缺失值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#Check remaining missing values if any </span></span><br><span class="line">all_data_na = (all_data.isnull().sum() / len(all_data)) * <span class="hljs-number">100</span></span><br><span class="line">all_data_na = all_data_na.drop(all_data_na[all_data_na == <span class="hljs-number">0</span>].index).sort_values(ascending=<span class="hljs-keyword">False</span>)</span><br><span class="line">missing_data = pd.DataFrame(&#123;<span class="hljs-string">'Missing Ratio'</span> :all_data_na&#125;)</span><br><span class="line">missing_data.head()</span><br></pre></td></tr></table></figure>
<h3 id="更多特征工程"><a href="#更多特征工程" class="headerlink" title="更多特征工程"></a>更多特征工程</h3><h4 id="将某些看起来是连续值的特征转换为离散值"><a href="#将某些看起来是连续值的特征转换为离散值" class="headerlink" title="将某些看起来是连续值的特征转换为离散值"></a>将某些看起来是连续值的特征转换为离散值</h4><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#MSSubClass=The building class</span></span><br><span class="line">all_data[<span class="hljs-string">'MSSubClass'</span>] = all_data[<span class="hljs-string">'MSSubClass'</span>].apply(str)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Changing OverallCond into a categorical variable</span></span><br><span class="line">all_data[<span class="hljs-string">'OverallCond'</span>] = all_data[<span class="hljs-string">'OverallCond'</span>].astype(str)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Year and month sold are transformed into categorical features.</span></span><br><span class="line">all_data[<span class="hljs-string">'YrSold'</span>] = all_data[<span class="hljs-string">'YrSold'</span>].astype(str)</span><br><span class="line">all_data[<span class="hljs-string">'MoSold'</span>] = all_data[<span class="hljs-string">'MoSold'</span>].astype(str)</span><br></pre></td></tr></table></figure>
<h4 id="标签编码一些带有排序信息的分类变量（例如，标签顺序按照出现次数大小排序）。"><a href="#标签编码一些带有排序信息的分类变量（例如，标签顺序按照出现次数大小排序）。" class="headerlink" title="标签编码一些带有排序信息的分类变量（例如，标签顺序按照出现次数大小排序）。"></a><strong>标签编码</strong>一些带有排序信息的分类变量（例如，标签顺序按照出现次数大小排序）。</h4><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> LabelEncoder</span><br><span class="line">cols = (<span class="hljs-string">'FireplaceQu'</span>, <span class="hljs-string">'BsmtQual'</span>, <span class="hljs-string">'BsmtCond'</span>, <span class="hljs-string">'GarageQual'</span>, <span class="hljs-string">'GarageCond'</span>, </span><br><span class="line">        <span class="hljs-string">'ExterQual'</span>, <span class="hljs-string">'ExterCond'</span>,<span class="hljs-string">'HeatingQC'</span>, <span class="hljs-string">'PoolQC'</span>, <span class="hljs-string">'KitchenQual'</span>, <span class="hljs-string">'BsmtFinType1'</span>, </span><br><span class="line">        <span class="hljs-string">'BsmtFinType2'</span>, <span class="hljs-string">'Functional'</span>, <span class="hljs-string">'Fence'</span>, <span class="hljs-string">'BsmtExposure'</span>, <span class="hljs-string">'GarageFinish'</span>, <span class="hljs-string">'LandSlope'</span>,</span><br><span class="line">        <span class="hljs-string">'LotShape'</span>, <span class="hljs-string">'PavedDrive'</span>, <span class="hljs-string">'Street'</span>, <span class="hljs-string">'Alley'</span>, <span class="hljs-string">'CentralAir'</span>, <span class="hljs-string">'MSSubClass'</span>, <span class="hljs-string">'OverallCond'</span>, </span><br><span class="line">        <span class="hljs-string">'YrSold'</span>, <span class="hljs-string">'MoSold'</span>)</span><br><span class="line"><span class="hljs-comment"># process columns, apply LabelEncoder to categorical features</span></span><br><span class="line"><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> cols:</span><br><span class="line">    lbl = LabelEncoder() </span><br><span class="line">    lbl.fit(list(all_data[c].values)) </span><br><span class="line">    all_data[c] = lbl.transform(list(all_data[c].values))</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># shape        </span></span><br><span class="line">print(<span class="hljs-string">'Shape all_data: &#123;&#125;'</span>.format(all_data.shape))</span><br></pre></td></tr></table></figure>
<h4 id="增加一个更为重要的特征"><a href="#增加一个更为重要的特征" class="headerlink" title="增加一个更为重要的特征"></a>增加一个更为重要的特征</h4><p>因为面积相关的特征对房价的影响是非常大的。所以我们增加了一个特征来描述基础设施的总面积，第一层和第二层的面积。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Adding total sqfootage feature </span></span><br><span class="line">all_data[<span class="hljs-string">'TotalSF'</span>] = all_data[<span class="hljs-string">'TotalBsmtSF'</span>] + all_data[<span class="hljs-string">'1stFlrSF'</span>] + all_data[<span class="hljs-string">'2ndFlrSF'</span>]</span><br></pre></td></tr></table></figure>
<h4 id="斜率特征"><a href="#斜率特征" class="headerlink" title="斜率特征"></a>斜率特征</h4><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">numeric_feats = all_data.dtypes[all_data.dtypes != <span class="hljs-string">"object"</span>].index</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Check the skew of all numerical features</span></span><br><span class="line">skewed_feats = all_data[numeric_feats].apply(<span class="hljs-keyword">lambda</span> x: skew(x.dropna())).sort_values(ascending=<span class="hljs-keyword">False</span>)</span><br><span class="line">print(<span class="hljs-string">"\nSkew in numerical features: \n"</span>)</span><br><span class="line">skewness = pd.DataFrame(&#123;<span class="hljs-string">'Skew'</span> :skewed_feats&#125;)</span><br><span class="line">skewness.head(<span class="hljs-number">10</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/images/房价预测/8.png" alt=""></p>
<h4 id="Box-Cox变换高斜率特征"><a href="#Box-Cox变换高斜率特征" class="headerlink" title="Box Cox变换高斜率特征"></a>Box Cox变换高斜率特征</h4><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">skewness = skewness[abs(skewness) &gt; <span class="hljs-number">0.75</span>]</span><br><span class="line">print(<span class="hljs-string">"There are &#123;&#125; skewed numerical features to Box Cox transform"</span>.format(skewness.shape[<span class="hljs-number">0</span>]))</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">from</span> scipy.special <span class="hljs-keyword">import</span> boxcox1p</span><br><span class="line">skewed_features = skewness.index</span><br><span class="line">lam = <span class="hljs-number">0.15</span></span><br><span class="line"><span class="hljs-keyword">for</span> feat <span class="hljs-keyword">in</span> skewed_features:</span><br><span class="line">    <span class="hljs-comment">#all_data[feat] += 1</span></span><br><span class="line">    all_data[feat] = boxcox1p(all_data[feat], lam)</span><br><span class="line">    </span><br><span class="line"><span class="hljs-comment">#all_data[skewed_features] = np.log1p(all_data[skewed_features])</span></span><br></pre></td></tr></table></figure>
<h4 id="获取分类特征的假值"><a href="#获取分类特征的假值" class="headerlink" title="获取分类特征的假值"></a>获取分类特征的假值</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">all_data = pd.get_dummies(all_data)</span><br><span class="line">print(all_data.shape)</span><br></pre></td></tr></table></figure>
<p>获取新的训练集和测试集</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">train = all_data[:ntrain]</span><br><span class="line">test = all_data[ntrain:]</span><br></pre></td></tr></table></figure>
<h2 id="5-模型"><a href="#5-模型" class="headerlink" title="5.模型"></a>5.模型</h2><p>导入相关库</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> ElasticNet, Lasso,  BayesianRidge, LassoLarsIC</span><br><span class="line"><span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestRegressor,  GradientBoostingRegressor</span><br><span class="line"><span class="hljs-keyword">from</span> sklearn.kernel_ridge <span class="hljs-keyword">import</span> KernelRidge</span><br><span class="line"><span class="hljs-keyword">from</span> sklearn.pipeline <span class="hljs-keyword">import</span> make_pipeline</span><br><span class="line"><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> RobustScaler</span><br><span class="line"><span class="hljs-keyword">from</span> sklearn.base <span class="hljs-keyword">import</span> BaseEstimator, TransformerMixin, RegressorMixin, clone</span><br><span class="line"><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> KFold, cross_val_score, train_test_split</span><br><span class="line"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error</span><br><span class="line"><span class="hljs-keyword">import</span> xgboost <span class="hljs-keyword">as</span> xgb</span><br><span class="line"><span class="hljs-keyword">import</span> lightgbm <span class="hljs-keyword">as</span> lgb</span><br></pre></td></tr></table></figure>
<h3 id="定义交叉策略"><a href="#定义交叉策略" class="headerlink" title="定义交叉策略"></a>定义交叉策略</h3><p>我们使用 Sklearn 中的 cross_cal_score 函数。然而这个函数没有扰乱属性，我们添加了一行代码，使得在交叉验证前对数据集进行扰乱。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#Validation function</span></span><br><span class="line">n_folds = <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rmsle_cv</span><span class="hljs-params">(model)</span>:</span></span><br><span class="line">    kf = KFold(n_folds, shuffle=<span class="hljs-keyword">True</span>, random_state=<span class="hljs-number">42</span>).get_n_splits(train.values)</span><br><span class="line">    rmse= np.sqrt(-cross_val_score(model, train.values, y_train, scoring=<span class="hljs-string">"neg_mean_squared_error"</span>, cv = kf))</span><br><span class="line">    <span class="hljs-keyword">return</span>(rmse)</span><br></pre></td></tr></table></figure>
<h3 id="基础模型"><a href="#基础模型" class="headerlink" title="基础模型"></a>基础模型</h3><ul>
<li>LASSO 回归：</li>
</ul>
<p>这个模型会对异常值特别敏感。所以我们需要让它变得更加鲁棒。在 pipeline 中使用 sklearn 中的 Robustscaler() 方法。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lasso = make_pipeline(RobustScaler(), Lasso(alpha =<span class="hljs-number">0.0005</span>, random_state=<span class="hljs-number">1</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>Elastic Net 回归：</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENet = make_pipeline(RobustScaler(), ElasticNet(alpha=<span class="hljs-number">0.0005</span>, l1_ratio=<span class="hljs-number">.9</span>, random_state=<span class="hljs-number">3</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>Kernel Ridge 回归：</li>
</ul>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KRR = KernelRidge(alpha=0.6, kernel=&apos;polynomial&apos;, degree=2, coef0=2.5)</span><br></pre></td></tr></table></figure>
<ul>
<li>Gradient Boosting 回归：</li>
</ul>
<p>使用 huber loss 使其对异常值鲁棒</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GBoost = GradientBoostingRegressor(n_estimators=<span class="hljs-number">3000</span>, learning_rate=<span class="hljs-number">0.05</span>,</span><br><span class="line">                                   max_depth=<span class="hljs-number">4</span>, max_features=<span class="hljs-string">'sqrt'</span>,</span><br><span class="line">                                   min_samples_leaf=<span class="hljs-number">15</span>, min_samples_split=<span class="hljs-number">10</span>, </span><br><span class="line">                                   loss=<span class="hljs-string">'huber'</span>, random_state =<span class="hljs-number">5</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>XGBoost:</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">model_xgb = xgb.XGBRegressor(colsample_bytree=<span class="hljs-number">0.4603</span>, gamma=<span class="hljs-number">0.0468</span>, </span><br><span class="line">                             learning_rate=<span class="hljs-number">0.05</span>, max_depth=<span class="hljs-number">3</span>, </span><br><span class="line">                             min_child_weight=<span class="hljs-number">1.7817</span>, n_estimators=<span class="hljs-number">2200</span>,</span><br><span class="line">                             reg_alpha=<span class="hljs-number">0.4640</span>, reg_lambda=<span class="hljs-number">0.8571</span>,</span><br><span class="line">                             subsample=<span class="hljs-number">0.5213</span>, silent=<span class="hljs-number">1</span>,</span><br><span class="line">                             random_state =<span class="hljs-number">7</span>, nthread = <span class="hljs-number">-1</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>LightGBM:</li>
</ul>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">model_lgb = lgb.LGBMRegressor(objective=<span class="hljs-string">'regression'</span>,num_leaves=<span class="hljs-number">5</span>,</span><br><span class="line">                              learning_rate=<span class="hljs-number">0.05</span>, n_estimators=<span class="hljs-number">720</span>,</span><br><span class="line">                              max_bin = <span class="hljs-number">55</span>, bagging_fraction = <span class="hljs-number">0.8</span>,</span><br><span class="line">                              bagging_freq = <span class="hljs-number">5</span>, feature_fraction = <span class="hljs-number">0.2319</span>,</span><br><span class="line">                              feature_fraction_seed=<span class="hljs-number">9</span>, bagging_seed=<span class="hljs-number">9</span>,</span><br><span class="line">                              min_data_in_leaf =<span class="hljs-number">6</span>, min_sum_hessian_in_leaf = <span class="hljs-number">11</span>)</span><br></pre></td></tr></table></figure>
<h3 id="基本模型分数"><a href="#基本模型分数" class="headerlink" title="基本模型分数"></a>基本模型分数</h3><p>模型初始化好之后就开始测试一下交叉验证的损失分数吧。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">score = rmsle_cv(lasso)</span><br><span class="line">print(<span class="hljs-string">"\nLasso score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n"</span>.format(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;Lasso score: 0.1115 (0.0074)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">score = rmsle_cv(ENet)</span><br><span class="line">print(<span class="hljs-string">"ElasticNet score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n"</span>.format(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;ElasticNet score: 0.1116 (0.0074)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">score = rmsle_cv(KRR)</span><br><span class="line">print(<span class="hljs-string">"Kernel Ridge score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n"</span>.format(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;Kernel Ridge score: 0.1153 (0.0075)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">score = rmsle_cv(GBoost)</span><br><span class="line">print(<span class="hljs-string">"Gradient Boosting score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n"</span>.format(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;Gradient Boosting score: 0.1177 (0.0080)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">score = rmsle_cv(model_xgb)</span><br><span class="line">print(<span class="hljs-string">"Xgboost score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n"</span>.format(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;Xgboost score: 0.1161 (0.0079)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">score = rmsle_cv(model_lgb)</span><br><span class="line">print(<span class="hljs-string">"LGBM score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n"</span> .format(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;LGBM score: 0.1157 (0.0067)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="堆叠模型（stacking-model"><a href="#堆叠模型（stacking-model" class="headerlink" title="堆叠模型（stacking model)"></a>堆叠模型（stacking model)</h3><h4 id="最简单的堆叠方法：平均化基础模型"><a href="#最简单的堆叠方法：平均化基础模型" class="headerlink" title="最简单的堆叠方法：平均化基础模型"></a>最简单的堆叠方法：平均化基础模型</h4><p>我们首先用最简单的方法实验，构建一个新类来拓展 scikit-learn 中 model类，作为我们自己的堆叠模型。</p>
<h5 id="平均化的基础模型类"><a href="#平均化的基础模型类" class="headerlink" title="平均化的基础模型类"></a>平均化的基础模型类</h5><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AveragingModels</span><span class="hljs-params">(BaseEstimator, RegressorMixin, TransformerMixin)</span>:</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, models)</span>:</span></span><br><span class="line">        self.models = models</span><br><span class="line">        </span><br><span class="line">    <span class="hljs-comment"># we define clones of the original models to fit the data in</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fit</span><span class="hljs-params">(self, X, y)</span>:</span></span><br><span class="line">        self.models_ = [clone(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.models]</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment"># Train cloned base models</span></span><br><span class="line">        <span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> self.models_:</span><br><span class="line">            model.fit(X, y)</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">#Now we do the predictions for cloned models and average them</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">predict</span><span class="hljs-params">(self, X)</span>:</span></span><br><span class="line">        predictions = np.column_stack([</span><br><span class="line">            model.predict(X) <span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> self.models_</span><br><span class="line">        ])</span><br><span class="line">        <span class="hljs-keyword">return</span> np.mean(predictions, axis=<span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>
<h5 id="平均化的基础模型分数"><a href="#平均化的基础模型分数" class="headerlink" title="平均化的基础模型分数"></a>平均化的基础模型分数</h5><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">averaged_models = AveragingModels(models = (ENet, GBoost, KRR, lasso))</span><br><span class="line"></span><br><span class="line">score = rmsle_cv(averaged_models)</span><br><span class="line">print(<span class="hljs-string">" Averaged base models score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n"</span>.format(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Averaged base models score: 0.1091 (0.0075)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>从结果看来，简单的堆叠模型确实提高了分数。这将激励我们探索更为高效的堆叠模型。</p>
<h4 id="不那么简单的堆叠模型：增加一个元模型"><a href="#不那么简单的堆叠模型：增加一个元模型" class="headerlink" title="不那么简单的堆叠模型：增加一个元模型"></a>不那么简单的堆叠模型：增加一个元模型</h4><p>在这个方法中，我们将会在简单堆叠模型的基础上增加一个元模型并使用基本模型的预测结果来训练元模型。</p>
<p>元模型的训练过程如下：</p>
<ol>
<li>划分数据集为两个分离的部分（train 和 holdout）</li>
<li>使用第一部分训练几个基本的模型（train）</li>
<li>在这些训练过的模型上使用第二部分进行测试（holdout）</li>
<li>使用3）中的预测结果作为输入，正确地响应作为输出来训练元模型</li>
</ol>
<p>前三步是可以迭代完成的。举例来说，我们有一个包含5个基本模型的堆叠模型，我们首先会把训练数据分为5份</p>
<p>。之后我们会做五次迭代。在每一次迭代中，我们在4份数据上训练基本模型然后在剩下的那份数据上预测。</p>
<p>可以确信的是，在五次迭代后，我们可以得到完整的5份由基本模型预测得到的训练数据，这在之后将会作为训练数据来训练我们的原模型。</p>
<p>在预测部分，我们会平均所有基础模型在测试数据上的预测结果，并将它们作为元特征，最终的预测结果将由元模型得出。</p>
<p><img src="/images/房价预测/9.png" alt=""></p>
<p>#####改进的堆叠模型类</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StackingAveragedModels</span><span class="hljs-params">(BaseEstimator, RegressorMixin, TransformerMixin)</span>:</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, base_models, meta_model, n_folds=<span class="hljs-number">5</span>)</span>:</span></span><br><span class="line">        self.base_models = base_models</span><br><span class="line">        self.meta_model = meta_model</span><br><span class="line">        self.n_folds = n_folds</span><br><span class="line">   </span><br><span class="line">    <span class="hljs-comment"># We again fit the data on clones of the original models</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fit</span><span class="hljs-params">(self, X, y)</span>:</span></span><br><span class="line">        self.base_models_ = [list() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.base_models]</span><br><span class="line">        self.meta_model_ = clone(self.meta_model)</span><br><span class="line">        kfold = KFold(n_splits=self.n_folds, shuffle=<span class="hljs-keyword">True</span>, random_state=<span class="hljs-number">156</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment"># Train cloned base models then create out-of-fold predictions</span></span><br><span class="line">        <span class="hljs-comment"># that are needed to train the cloned meta-model</span></span><br><span class="line">        out_of_fold_predictions = np.zeros((X.shape[<span class="hljs-number">0</span>], len(self.base_models)))</span><br><span class="line">        <span class="hljs-keyword">for</span> i, model <span class="hljs-keyword">in</span> enumerate(self.base_models):</span><br><span class="line">            <span class="hljs-keyword">for</span> train_index, holdout_index <span class="hljs-keyword">in</span> kfold.split(X, y):</span><br><span class="line">                instance = clone(model)</span><br><span class="line">                self.base_models_[i].append(instance)</span><br><span class="line">                instance.fit(X[train_index], y[train_index])</span><br><span class="line">                y_pred = instance.predict(X[holdout_index])</span><br><span class="line">                out_of_fold_predictions[holdout_index, i] = y_pred</span><br><span class="line">                </span><br><span class="line">        <span class="hljs-comment"># Now train the cloned  meta-model using the out-of-fold predictions as new feature</span></span><br><span class="line">        self.meta_model_.fit(out_of_fold_predictions, y)</span><br><span class="line">        <span class="hljs-keyword">return</span> self</span><br><span class="line">   </span><br><span class="line">    <span class="hljs-comment">#Do the predictions of all base models on the test data and use the averaged predictions as </span></span><br><span class="line">    <span class="hljs-comment">#meta-features for the final prediction which is done by the meta-model</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">predict</span><span class="hljs-params">(self, X)</span>:</span></span><br><span class="line">        meta_features = np.column_stack([</span><br><span class="line">            np.column_stack([model.predict(X) <span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> base_models]).mean(axis=<span class="hljs-number">1</span>)</span><br><span class="line">            <span class="hljs-keyword">for</span> base_models <span class="hljs-keyword">in</span> self.base_models_ ])</span><br><span class="line">        <span class="hljs-keyword">return</span> self.meta_model_.predict(meta_features)</span><br></pre></td></tr></table></figure>
<h5 id="改进的堆叠模型的分数"><a href="#改进的堆叠模型的分数" class="headerlink" title="改进的堆叠模型的分数"></a>改进的堆叠模型的分数</h5><p>为了使得两种方法有可比性（使用了同样数量的基础模型），我们使用了 Enet、KRR、Gboost作为基础模型，使用 lasso 作为元模型。</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stacked_averaged_models = StackingAveragedModels(base_models = (ENet, GBoost, KRR),</span><br><span class="line">                                                 meta_model = lasso)</span><br><span class="line"></span><br><span class="line">score = rmsle_cv(stacked_averaged_models)</span><br><span class="line">print(<span class="hljs-string">"Stacking Averaged models score: &#123;:.4f&#125; (&#123;:.4f&#125;)"</span>.format(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;Stacking Averaged models score: 0.1085 (0.0074)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>通过加入元模型确实得到了更好的结果。</p>
<h3 id="融合模型"><a href="#融合模型" class="headerlink" title="融合模型"></a>融合模型</h3><p>我们增加了 XGBoost、LightGBM 到之前定义的堆叠模型中。</p>
<p>我们首先定义一个评估函数 rmsle</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rmsle</span><span class="hljs-params">(y, y_pred)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> np.sqrt(mean_squared_error(y, y_pred))</span><br></pre></td></tr></table></figure>
<h4 id="最终的训练和预测"><a href="#最终的训练和预测" class="headerlink" title="最终的训练和预测"></a>最终的训练和预测</h4><p><strong>StackRegressor:</strong></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stacked_averaged_models.fit(train.values, y_train)</span><br><span class="line">stacked_train_pred = stacked_averaged_models.predict(train.values)</span><br><span class="line">stacked_pred = np.expm1(stacked_averaged_models.predict(test.values))</span><br><span class="line">print(rmsle(y_train, stacked_train_pred))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;0.0781571937916</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>XGBoost:</strong></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">model_xgb.fit(train, y_train)</span><br><span class="line">xgb_train_pred = model_xgb.predict(train)</span><br><span class="line">xgb_pred = np.expm1(model_xgb.predict(test))</span><br><span class="line">print(rmsle(y_train, xgb_train_pred))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;0.0785165142425</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>LightGBM:</strong></p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">model_lgb.fit(train, y_train)</span><br><span class="line">lgb_train_pred = model_lgb.predict(train)</span><br><span class="line">lgb_pred = np.expm1(model_lgb.predict(test.values))</span><br><span class="line">print(rmsle(y_train, lgb_train_pred))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;0.0716757468834</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">'''RMSE on the entire Train data when averaging'''</span></span><br><span class="line"></span><br><span class="line">print(<span class="hljs-string">'RMSLE score on train data:'</span>)</span><br><span class="line">print(rmsle(y_train,stacked_train_pred*<span class="hljs-number">0.70</span> +</span><br><span class="line">               xgb_train_pred*<span class="hljs-number">0.15</span> + lgb_train_pred*<span class="hljs-number">0.15</span> ))</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;RMSLE score on train data:</span><br><span class="line">&gt;0.0752190464543</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>融合预测：</strong></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ensemble = stacked_pred*<span class="hljs-number">0.70</span> + xgb_pred*<span class="hljs-number">0.15</span> + lgb_pred*<span class="hljs-number">0.15</span></span><br></pre></td></tr></table></figure>
<p><strong>提交：</strong></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sub = pd.DataFrame()</span><br><span class="line">sub[<span class="hljs-string">'Id'</span>] = test_ID</span><br><span class="line">sub[<span class="hljs-string">'SalePrice'</span>] = ensemble</span><br><span class="line">sub.to_csv(<span class="hljs-string">'submission.csv'</span>,index=<span class="hljs-keyword">False</span>)</span><br></pre></td></tr></table></figure>

        </div>
        
        
        
    </div>
</div>





</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    <img class="image is-128x128 has-mb-6" src="/images/wangye.jpeg" alt="彭一峰">
                    
                    <p class="is-size-4 is-block">
                        彭一峰
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        曾在新浪微博、中科院自动化所实习。
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>BeiJing, China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Posts
                    </p>
                    <p class="title has-text-weight-normal">
                        4
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Categories
                    </p>
                    <p class="title has-text-weight-normal">
                        2
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Tags
                    </p>
                    <p class="title has-text-weight-normal">
                        3
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/MountainOne">
                Follow</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/MountainOne">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Facebook" href="http://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Twitter" href="http://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Dribbble" href="http://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Links
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">https://hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/MountainOne" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Github</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">https://github.com/MountainOne</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Deep-Learning/">
            <span class="level-start">
                <span class="level-item">Deep Learning</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数据挖掘/">
            <span class="level-start">
                <span class="level-item">数据挖掘</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Tag Cloud
        </h3>
        <a href="/tags/Kaggle/" style="font-size: 10px;">Kaggle</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/image-segmentation/" style="font-size: 10px;">image segmentation</a>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Recent
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-14T10:55:01.000Z">2018-12-14</time></div>
                    <a href="/2018/12/14/基于深度学习的图像语义分割综述（译）/" class="has-link-black-ter is-size-6">基于深度学习的图像语义分割综述（译）</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Deep-Learning/">Deep Learning</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-10T14:47:26.000Z">2018-12-10</time></div>
                    <a href="/2018/12/10/自己动手写Shell——C实现/" class="has-link-black-ter is-size-6">自己动手写Shell——C实现</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-06T20:41:32.000Z">2018-12-06</time></div>
                    <a href="/2018/12/07/Kaggle之房价预测/" class="has-link-black-ter is-size-6">Kaggle之房价预测</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/数据挖掘/">数据挖掘</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-05T14:30:00.000Z">2018-12-05</time></div>
                    <a href="/2018/12/05/从源码编译和安装Linux内核/" class="has-link-black-ter is-size-6">从源码编译和安装Linux内核</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Archives
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">December 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <ul class="menu-list">
                
                <li>
                    <a class="level is-marginless" href="/tags/Kaggle/">
                        <span class="level-start">
                            <span class="level-item">Kaggle</span>
                        </span>
                        <span class="level-end">
                            <span class="level-item tag">1</span>
                        </span>
                    </a>
                </li>
                
                <li>
                    <a class="level is-marginless" href="/tags/Linux/">
                        <span class="level-start">
                            <span class="level-item">Linux</span>
                        </span>
                        <span class="level-end">
                            <span class="level-item tag">2</span>
                        </span>
                    </a>
                </li>
                
                <li>
                    <a class="level is-marginless" href="/tags/image-segmentation/">
                        <span class="level-start">
                            <span class="level-item">image segmentation</span>
                        </span>
                        <span class="level-end">
                            <span class="level-item tag">1</span>
                        </span>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Recent
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-14T10:55:01.000Z">2018-12-14</time></div>
                    <a href="/2018/12/14/基于深度学习的图像语义分割综述（译）/" class="has-link-black-ter is-size-6">基于深度学习的图像语义分割综述（译）</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Deep-Learning/">Deep Learning</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-10T14:47:26.000Z">2018-12-10</time></div>
                    <a href="/2018/12/10/自己动手写Shell——C实现/" class="has-link-black-ter is-size-6">自己动手写Shell——C实现</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-06T20:41:32.000Z">2018-12-06</time></div>
                    <a href="/2018/12/07/Kaggle之房价预测/" class="has-link-black-ter is-size-6">Kaggle之房价预测</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/数据挖掘/">数据挖掘</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-05T14:30:00.000Z">2018-12-05</time></div>
                    <a href="/2018/12/05/从源码编译和安装Linux内核/" class="has-link-black-ter is-size-6">从源码编译和安装Linux内核</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Archives
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">December 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <ul class="menu-list">
                
                <li>
                    <a class="level is-marginless" href="/tags/Kaggle/">
                        <span class="level-start">
                            <span class="level-item">Kaggle</span>
                        </span>
                        <span class="level-end">
                            <span class="level-item tag">1</span>
                        </span>
                    </a>
                </li>
                
                <li>
                    <a class="level is-marginless" href="/tags/Linux/">
                        <span class="level-start">
                            <span class="level-item">Linux</span>
                        </span>
                        <span class="level-end">
                            <span class="level-item tag">2</span>
                        </span>
                    </a>
                </li>
                
                <li>
                    <a class="level is-marginless" href="/tags/image-segmentation/">
                        <span class="level-start">
                            <span class="level-item">image segmentation</span>
                        </span>
                        <span class="level-end">
                            <span class="level-item tag">1</span>
                        </span>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/wangye.jpeg" alt="MountainOne&#39;s technology space" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2018 MountainOne&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-icarus">Icarus</a>
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/MountainOne">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
});
</script>

    
    

<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>